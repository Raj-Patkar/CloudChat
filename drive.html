<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CloudDrive</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <h1>📁 CloudDrive 🚀</h1>
  <h3 id="welcome-message"></h3>

  <input type="file" id="file-input">
  <button onclick="uploadFile()">Upload File</button>
  <button onclick="logout()">Logout</button>

  <h3>Your Files:</h3>
  <div id="file-list"></div>

  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
  <script src="firebase-config.js"></script>

  <script>
    const auth = firebase.auth();
    const db = firebase.database();
    const uploadFunctionURL = "https://us-central1-deep-wares-462607-b4.cloudfunctions.net/uploadImage"; // Replace with your deployed function endpoint

    auth.onAuthStateChanged((user) => {
      if (user) {
        document.getElementById('welcome-message').textContent = `Welcome, ${user.email}`;
        loadFiles();
      } else {
        window.location.href = "index.html";
      }
    });

    function uploadFile() {
      const fileInput = document.getElementById('file-input');
      const file = fileInput.files[0];
      if (!file) return alert('Please select a file.');

      const formData = new FormData();
      formData.append('file', file);

      fetch(uploadFunctionURL, {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.url) {
          const user = auth.currentUser;
          const newFileRef = db.ref(`drive/${user.uid}`).push();
          newFileRef.set({
            name: file.name,
            url: data.url,
            uploadedAt: Date.now()
          }).then(() => {
            alert('File uploaded!');
            fileInput.value = '';
            loadFiles();
          });
        } else {
          alert('Upload failed.');
        }
      })
      .catch(err => {
        console.error(err);
        alert('Error uploading file.');
      });
    }

    function loadFiles() {
      const user = auth.currentUser;
      const fileList = document.getElementById('file-list');
      fileList.innerHTML = 'Loading...';

      db.ref(`drive/${user.uid}`).once('value').then(snapshot => {
        const files = snapshot.val();
        fileList.innerHTML = '';

        if (files) {
          Object.keys(files).forEach(key => {
            const file = files[key];
            const div = document.createElement('div');
            div.innerHTML = `
              <a href="${file.url}" target="_blank">${file.name}</a>
              <button onclick="deleteFile('${key}', '${file.name}')">Delete</button>
            `;
            fileList.appendChild(div);
          });
        } else {
          fileList.innerHTML = 'No files found.';
        }
      });
    }

    function deleteFile(key, name) {
      const user = auth.currentUser;
      if (confirm(`Delete ${name}?`)) {
        db.ref(`drive/${user.uid}/${key}`).remove().then(() => {
          alert('Deleted from database. Note: file will still exist in bucket unless you handle that server-side.');
          loadFiles();
        });
      }
    }

    function logout() {
      auth.signOut().then(() => {
        window.location.href = "index.html";
      });
    }
  </script>
</body>
</html>
